name: Claude Auto-Fix

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get CI failure logs
        id: get-logs
        run: |
          echo "Getting failure details from CI run..."
          # This would normally fetch detailed logs from the failed workflow
          echo "CI_FAILED=true" >> $GITHUB_OUTPUT

      - name: Install Claude Code
        if: steps.get-logs.outputs.CI_FAILED == 'true'
        run: |
          curl -fsSL https://raw.githubusercontent.com/anthropics/claude-code/main/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run Claude Auto-Fix
        if: steps.get-logs.outputs.CI_FAILED == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Configure Claude to bypass permissions in CI
          export CLAUDE_DANGEROUS_SKIP_PERMISSIONS=1

          # Run Claude to fix linting/formatting issues
          claude -p "Fix the CI failures. Focus on:
          1. ESLint errors - auto-fix what's fixable
          2. TypeScript errors - simple fixes only
          3. Formatting issues
          4. Unused imports

          DO NOT fix:
          - Test failures (logic issues)
          - Security vulnerabilities
          - Complex refactoring

          If you can't auto-fix safely, exit gracefully."

      - name: Commit fixes
        if: steps.get-logs.outputs.CI_FAILED == 'true'
        run: |
          git config --local user.email "claude-auto-fix[bot]@users.noreply.github.com"
          git config --local user.name "Claude Auto-Fix Bot"

          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "fix: auto-fix CI failures (ESLint, TypeScript, formatting)

            ü§ñ Generated by Claude Auto-Fix
            Workflow Run: ${{ github.event.workflow_run.html_url }}"

            git push
          else
            echo "No changes to commit"
            exit 1
          fi

      - name: Re-trigger CI
        if: success()
        run: |
          echo "Auto-fix applied. CI will re-run automatically."

      - name: Notify failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Claude Auto-Fix could not resolve the CI failures."
          echo "Manual intervention required."
          exit 1
